name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add SSH host keys
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -p 1322 -H amane.ie.u-ryukyu.ac.jp >> ~/.ssh/known_hosts
        ssh-keyscan -p 1322 -H 10.0.6.56 >> ~/.ssh/known_hosts
        
    - name: Configure SSH for ProxyJump
      run: |
        cat >> ~/.ssh/config << 'EOF'
        Host amane
          HostName amane.ie.u-ryukyu.ac.jp
          Port 1322
          User e215705
          StrictHostKeyChecking no
          
        Host react_web
          HostName 10.0.6.56
          Port 1322
          User react_web
          ProxyJump amane
          StrictHostKeyChecking no
        EOF
        
    - name: Deploy to server
      run: |
        rsync -avz --exclude 'node_modules' --exclude '.git' ./ react_web:/var/www/my-portfolio/
        
    - name: Install dependencies and build
      run: |
        ssh react_web << 'EOF'
        cd /var/www/my-portfolio
        npm ci
        npm run build
        pm2 restart my-portfolio
        EOF