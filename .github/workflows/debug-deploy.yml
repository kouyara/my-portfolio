name: Debug Deploy Issues

on:
  workflow_dispatch: # Manual trigger only

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Network and SSH Debug
        run: |
          echo "=== System Information ==="
          uname -a
          cat /etc/os-release
          
          echo "=== Network Connectivity ==="
          ping -c 3 8.8.8.8 || echo "No internet connectivity"
          
          echo "=== DNS Resolution ==="
          nslookup ${{ secrets.PROXY_HOST }} || echo "Cannot resolve proxy host"
          
          echo "=== SSH Client Version ==="
          ssh -V
          
          echo "=== Available SSH Algorithms ==="
          ssh -Q cipher
          ssh -Q mac
          ssh -Q kex

      - name: Setup SSH with Detailed Logging
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # SSH config with verbose logging
          cat > ~/.ssh/config << 'CONFIG'
          Host amane
            Hostname ${{ secrets.PROXY_HOST }}
            Port ${{ secrets.PROXY_PORT }}
            User ${{ secrets.PROXY_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel VERBOSE
          
          Host react_web
            Hostname ${{ secrets.SERVER_HOST }}
            Port 1322
            User ${{ secrets.SERVER_USER }}
            ProxyJump amane
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel VERBOSE
          CONFIG
          
          echo "=== SSH Config ==="
          cat ~/.ssh/config
          
          echo "=== SSH Key Info ==="
          ssh-keygen -l -f ~/.ssh/id_rsa || echo "Invalid SSH key format"

      - name: Test Connectivity Step by Step
        run: |
          echo "=== Testing Proxy Connection ==="
          timeout 30 ssh -v -o ConnectTimeout=10 amane "echo 'Proxy connection successful'" 2>&1 || echo "Proxy connection failed"
          
          echo "=== Testing Target Server Connection ==="
          timeout 30 ssh -v -o ConnectTimeout=10 react_web "echo 'Target server connection successful'" 2>&1 || echo "Target server connection failed"

      - name: Network Troubleshooting
        run: |
          echo "=== Port Connectivity Test ==="
          nc -zv ${{ secrets.PROXY_HOST }} ${{ secrets.PROXY_PORT }} 2>&1 || echo "Cannot reach proxy port"
          
          echo "=== Traceroute to Proxy ==="
          traceroute ${{ secrets.PROXY_HOST }} 2>&1 || echo "Traceroute failed"